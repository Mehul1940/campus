{% extends 'core/base.html' %}

{% block title %}Shopping Cart - Campus Hub{% endblock %}

{% block content %}
<div class="container py-5">

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="fw-800 mb-0">
                <i class="bi bi-cart3 text-primary me-2"></i>
                Shopping Cart
            </h1>
            <p class="text-muted small">Review your selected meals before checkout</p>
        </div>
    </div>

    <div class="row g-4">

        <!-- Cart Items -->
        <div class="col-lg-8">
            {% if not cart_empty %}
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="fw-bold mb-0 text-uppercase small">Cart Items</h6>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light small text-uppercase">
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ item.item.image.url }}" class="rounded-3 me-3"
                                                style="width:60px; height:60px; object-fit:cover;"
                                                alt="{{ item.item.name }}">
                                            <div>
                                                <h6 class="mb-1 fw-bold">{{ item.item.name }}</h6>
                                                <small class="text-muted">
                                                    {{ item.item.get_category_display }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="fw-semibold">
                                        ₹ {{ item.item.price }}
                                    </td>

                                    <td>
                                        <div class="d-flex align-items-center">

                                            <button
                                                class="btn btn-sm btn-outline-secondary decrease-qty rounded-circle me-2"
                                                data-item-id="{{ item.item.id }}">
                                                <i class="bi bi-dash"></i>
                                            </button>

                                            <span class="badge bg-primary rounded-pill px-3 py-2">
                                                {{ item.quantity }}
                                            </span>

                                            <button
                                                class="btn btn-sm btn-outline-secondary increase-qty rounded-circle ms-2"
                                                data-item-id="{{ item.item.id }}">
                                                <i class="bi bi-plus"></i>
                                            </button>

                                        </div>
                                    </td>

                                    <td class="fw-bold text-primary">
                                        ₹ {{ item.total }}
                                    </td>

                                    <td>
                                        <button class="btn btn-sm btn-outline-danger remove-from-cart rounded-circle"
                                            data-item-id="{{ item.item.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card border-0 shadow-sm rounded-4 text-center py-5">
                <div class="card-body">
                    <i class="bi bi-cart-x text-primary" style="font-size: 3rem;"></i>
                    <h5 class="fw-bold mt-3">Your cart is empty</h5>
                    <p class="text-muted">Start adding delicious meals</p>
                    <a href="{% url 'canteen:menu' %}" class="btn btn-primary px-4">
                        <i class="bi bi-plus-circle me-1"></i>
                        Browse Menu
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top:90px;">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="fw-bold mb-0 text-uppercase small">
                        <i class="bi bi-receipt me-1"></i>
                        Order Summary
                    </h6>
                </div>

                <div class="card-body">
                    {% if not cart_empty %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span class="fw-semibold">₹ {{ total_price }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Delivery</span>
                        <span class="fw-semibold text-success">Free</span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold fs-5">Total</span>
                        <span class="fw-bold fs-5 text-primary">
                            ₹ {{ total_price }}
                        </span>
                    </div>

                    <a href="{% url 'canteen:checkout' %}" class="btn btn-primary w-100 py-2 mb-2 fw-bold shadow-sm">
                        <i class="bi bi-credit-card me-1"></i>
                        Proceed to Checkout
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Hidden CSRF token for JavaScript -->
<div style="display: none;">{% csrf_token %}</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function updateCart(itemId, action) {
        fetch("{% url 'canteen:update_cart' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify({
                item_id: itemId,
                action: action
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error updating cart');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }

    document.querySelectorAll('.increase-qty').forEach(btn => {
        btn.addEventListener('click', function () {
            updateCart(this.dataset.itemId, "increase");
        });
    });

    document.querySelectorAll('.decrease-qty').forEach(btn => {
        btn.addEventListener('click', function () {
            updateCart(this.dataset.itemId, "decrease");
        });
    });

    document.querySelectorAll('.remove-from-cart').forEach(btn => {
        btn.addEventListener('click', function () {
            updateCart(this.dataset.itemId, "remove");
        });
    });
</script>
{% endblock %}